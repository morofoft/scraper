<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Issue de GitHub</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuración de la fuente Inter para mejor legibilidad */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Estilo para el contenedor de cambios en el historial */
        .change-item {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        .change-item::before {
            content: '•'; /* Punto o viñeta */
            color: #3b82f6; /* Azul de Tailwind 500 */
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="mb-8 p-6 bg-white shadow-xl rounded-xl">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Seguimiento de Issue</h1>
            <p class="text-gray-600">Descargando y visualizando el estado y el historial de cambios en tiempo real desde GitHub.</p>
        </header>

        <!-- Contenedor principal para la aplicación -->
        <main id="app-container">
            <!-- Loader y mensaje inicial -->
            <div id="loading" class="flex flex-col items-center justify-center p-12 bg-white rounded-xl shadow-lg">
                <svg class="animate-spin h-8 w-8 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-lg font-medium text-gray-700">Cargando datos del issue...</p>
            </div>

            <!-- Aquí se insertará el contenido principal del issue -->
            <div id="issue-content" class="hidden">
                <!-- Tarjeta de Estado Actual -->
                <div class="bg-blue-600 text-white p-6 rounded-xl shadow-xl mb-6 flex justify-between items-center">
                    <div>
                        <p class="text-sm font-light uppercase opacity-80">Estado Actual del Issue</p>
                        <h2 id="estado-actual" class="text-4xl font-extrabold mt-1"></h2>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-light opacity-70">Última Actualización</p>
                        <p id="actualizado" class="text-lg font-semibold"></p>
                    </div>
                </div>

                <!-- Tarjeta de Historial -->
                <div class="bg-white p-6 rounded-xl shadow-xl">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Historial de Cambios</h3>
                    <div id="historial-container" class="space-y-6">
                        <!-- El historial se insertará aquí -->
                    </div>
                </div>
            </div>

            <!-- Mensaje de Error (oculto por defecto) -->
            <div id="error-message" class="hidden p-6 bg-red-100 border border-red-400 text-red-700 rounded-xl shadow-lg" role="alert">
                <p class="font-bold">Error al cargar los datos</p>
                <p id="error-details"></p>
                <p class="mt-2 text-sm">Por favor, verifica la conexión o la URL del archivo.</p>
            </div>
        </main>
    </div>

    <script>
        // URL del archivo JSON raw en GitHub
        const GITHUB_JSON_URL = "https://raw.githubusercontent.com/morofoft/scraper/main/datos_issue.json";

        // Elementos del DOM
        const loadingEl = document.getElementById('loading');
        const issueContentEl = document.getElementById('issue-content');
        const errorEl = document.getElementById('error-message');
        const errorDetailsEl = document.getElementById('error-details');
        const estadoActualEl = document.getElementById('estado-actual');
        const actualizadoEl = document.getElementById('actualizado');
        const historialContainerEl = document.getElementById('historial-container');

        /**
         * Función principal para descargar y renderizar los datos.
         */
        async function loadIssueData() {
            loadingEl.classList.remove('hidden');
            issueContentEl.classList.add('hidden');
            errorEl.classList.add('hidden');

            try {
                // 1. Descarga del JSON
                const response = await fetch(GITHUB_JSON_URL);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                }

                // 2. Parseo del JSON
                const data = await response.json();

                // 3. Renderizado de la información general
                estadoActualEl.textContent = data.estado_actual || 'N/A';
                actualizadoEl.textContent = data.actualizado || 'N/A';

                // 4. Renderizado del historial
                renderHistorial(data.historial || []);

                // 5. Mostrar contenido y ocultar loader
                loadingEl.classList.add('hidden');
                issueContentEl.classList.remove('hidden');

            } catch (error) {
                // 6. Manejo de errores
                console.error("Fallo al procesar los datos:", error);
                loadingEl.classList.add('hidden');
                errorDetailsEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            }
        }

        /**
         * Crea y añade los elementos del historial al contenedor.
         * @param {Array<Object>} historial - Array de objetos del historial.
         */
        function renderHistorial(historial) {
            // Limpiamos cualquier contenido previo
            historialContainerEl.innerHTML = '';

            if (historial.length === 0) {
                historialContainerEl.innerHTML = '<p class="text-gray-500 italic">No se encontraron entradas de historial.</p>';
                return;
            }

            // Iteramos sobre las entradas del historial (las mostramos en orden cronológico inverso, más reciente primero)
            historial.slice().reverse().forEach(entry => {
                // Crear el elemento de la tarjeta para la entrada del historial
                const entryCard = document.createElement('div');
                entryCard.className = 'border border-gray-200 p-4 rounded-lg bg-gray-50 hover:shadow-md transition duration-300';

                // Título y metadatos
                entryCard.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between border-b pb-2 mb-2">
                        <h4 class="text-lg font-bold text-blue-700">${entry.numero} - ${entry.usuario || 'Usuario Desconocido'}</h4>
                        <p class="text-sm text-gray-500 mt-1 sm:mt-0">${entry.fecha || 'Fecha Desconocida'}</p>
                    </div>
                    <div class="mt-3">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Detalles de los Cambios:</p>
                        <ul class="list-none pl-0" id="cambios-${entry.numero.replace('#', '')}">
                            <!-- Cambios se insertarán aquí -->
                        </ul>
                    </div>
                `;

                // Insertar los cambios específicos
                const cambiosList = entryCard.querySelector(`#cambios-${entry.numero.replace('#', '')}`);
                const cambios = entry.cambios || [];

                if (cambios.length > 0) {
                    cambios.forEach(cambio => {
                        const listItem = document.createElement('li');
                        listItem.className = 'text-gray-600 text-sm change-item';
                        listItem.textContent = cambio;
                        cambiosList.appendChild(listItem);
                    });
                } else {
                    const listItem = document.createElement('li');
                    listItem.className = 'text-gray-500 italic text-sm';
                    listItem.textContent = 'No hay cambios específicos registrados en esta entrada.';
                    cambiosList.appendChild(listItem);
                }

                historialContainerEl.appendChild(entryCard);
            });
        }

        // Llamamos a la función al cargar la página
        window.onload = loadIssueData;
    </script>
</body>
</html>
